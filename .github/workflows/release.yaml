name: System Agent Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write # to create releases
  id-token: write # to read vault secrets

env:
  TAG: ${{ github.ref_name }}

jobs:
  # Build Docker images using multi-stage Dockerfile
  release:
    name: Build and push images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            tag-suffix: "linux-amd64"
          - arch: arm64
            tag-suffix: "linux-arm64"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read Vault secrets
        uses: rancher-eio/read-vault-secrets@main
        with:
          secrets: |
            secret/data/github/repo/${{ github.repository }}/dockerhub/rancher/credentials username | DOCKER_USERNAME ;
            secret/data/github/repo/${{ github.repository }}/dockerhub/rancher/credentials password | DOCKER_PASSWORD

      - name: Publish Image
        uses: rancher/ecm-distro-tools/actions/publish-image@master
        env:
          TAG: ${{ github.ref_name }}
          ARCH: ${{ matrix.arch }}
          GOOS: linux
          TAG_SUFFIX: ${{ matrix.tag-suffix }}
          COMMIT: ${{ github.sha }}
        with:
          image: "system-agent"
          tag: ${{ github.ref_name }}
          make-target: docker-buildx-push

          public-repo: rancher
          public-username: ${{ env.DOCKER_USERNAME }}
          public-password: ${{ env.DOCKER_PASSWORD }}

          push-to-prime: false

      - name: Publish Image
        uses: rancher/ecm-distro-tools/actions/publish-image@master
        env:
          TAG: ${{ github.ref_name }}
          ARCH: ${{ matrix.arch }}
          GOOS: linux
          TAG_SUFFIX: ${{ matrix.tag-suffix }}
          COMMIT: ${{ github.sha }}
        with:
          image: "system-agent"
          tag: ${{ github.ref_name }}
          make-target: docker-buildx-push-suc

          public-repo: rancher
          public-username: ${{ env.DOCKER_USERNAME }}
          public-password: ${{ env.DOCKER_PASSWORD }}

          push-to-prime: false

  merge:
    runs-on: ubuntu-latest
    needs:
      - release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read Vault secrets
        uses: rancher-eio/read-vault-secrets@main
        with:
          secrets: |
            secret/data/github/repo/${{ github.repository }}/dockerhub/rancher/credentials username | DOCKER_USERNAME ;
            secret/data/github/repo/${{ github.repository }}/dockerhub/rancher/credentials password | DOCKER_PASSWORD

      - name: Log into Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Create and push multi-platform manifests
        run: make docker-manifest
        env:
          TAG: ${{ github.ref_name }}

  github_release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs:
      - merge
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Read App Secrets
        uses: rancher-eio/read-vault-secrets@main
        with:
          secrets: |
            secret/data/github/repo/${{ github.repository }}/github/app-credentials appId | APP_ID ;
            secret/data/github/repo/${{ github.repository }}/github/app-credentials privateKey | PRIVATE_KEY

      - name: Create App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ env.APP_ID }}
          private-key: ${{ env.PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build release binaries
        run: make release-binaries
        env:
          VERSION: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh release create ${{ github.ref_name }} \
            --verify-tag \
            --generate-notes \
            dist/*
